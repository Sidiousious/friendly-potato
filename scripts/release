#!/usr/bin/env bash

set -e
set -u

dotnet build FriendlyPotato/FriendlyPotato.csproj -c Release --output ./out

versionize

# Build again to get correct version number in assembly
dotnet build FriendlyPotato/FriendlyPotato.csproj -c Release --output ./out
git push --follow-tags

VERSION=$(versionize inspect)
cat << EOF > repository.json
[
  {
    "Author": "YF",
    "Name": "Friendly Potato",
    "InternalName": "FriendlyPotato",
    "AssemblyVersion": "$VERSION",
    "Description": "An informational plugin.",
    "ApplicableVersion": "any",
    "RepoUrl": "https://github.com/Sidiousious/friendly-potato",
    "Tags": [
      "Hunt",
      "Information"
    ],
    "DalamudApiLevel": 11,
    "LoadPriority": 0,
    "DownloadCount": 69,
    "IconUrl": "https://yfplugins.kinkop.eu/friendlypotatologo.png",
    "Punchline": "An information plugin.",
    "IsHide": "False",
    "IsTestingExclusive": "False",
    "DownloadLinkInstall": "https://yfplugins.kinkop.eu/friendly-potato/$VERSION.zip",
    "DownloadLinkTesting": "https://yfplugins.kinkop.eu/friendly-potato/$VERSION.zip",
    "DownloadLinkUpdate": "https://yfplugins.kinkop.eu/friendly-potato/$VERSION.zip"
  }
]
EOF

#aws s3 --profile kinkop cp out/FriendlyPotato/latest.zip s3://yfplugins/friendly-potato/$VERSION.zip
#aws s3 --profile kinkop cp repository.json s3://yfplugins/friendly-potato/repository.json
s3cmd -c ~/.s3cfg-kinkop put out/FriendlyPotato/latest.zip s3://yfplugins/friendly-potato/$VERSION.zip
s3cmd -c ~/.s3cfg-kinkop put repository.json s3://yfplugins/friendly-potato/repository.json
